{% extends 'patient/base.html' %}
{% block title %}Sesiones{% endblock %}

{% block content %}
<div class="p-4 md:p-6">
  <h2 class="text-2xl font-bold text-textDark mb-4">Sesión y Juegos Asignados</h2>
  <p class="text-sm text-gray-600 mb-4">Ingresa el ID de tu sesión programada para ver y abrir los juegos asignados por tu terapeuta.</p>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-surface rounded-soft shadow-soft p-4 md:p-6">
      <label class="text-sm text-gray-700">ID de Sesión</label>
      <div class="flex items-center gap-3 mt-2">
        <input id="session-id-input" type="number" class="flex-1 px-3 py-2 border rounded-soft" placeholder="Ej: 123" />
        <button id="load-session-games" class="px-4 py-2 bg-primary text-white rounded-soft">Cargar</button>
      </div>
      <p id="session-status" class="text-xs text-gray-500 mt-2"></p>

      <h3 class="text-lg font-semibold text-textDark mt-4 mb-2">Juegos Asignados</h3>
      <ul id="assigned-games" class="space-y-2"></ul>
    </div>

    <div class="bg-surface rounded-soft shadow-soft p-4 md:p-6">
      <h3 class="text-lg font-semibold text-textDark mb-2">Vista del Juego</h3>
      <iframe id="patient-game-frame" class="w-full h-[300px] md:h-[480px] rounded-soft border"></iframe>
    </div>
  </div>

  <div class="mt-6 text-xs text-gray-500">
    <p>Nota: Los juegos solo se habilitan dentro del horario de la sesión programada. Si aún no están habilitados, espera al inicio de tu sesión.</p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const sessionInput = document.getElementById('session-id-input');
    const loadBtn = document.getElementById('load-session-games');
    const statusEl = document.getElementById('session-status');
    const listEl = document.getElementById('assigned-games');
    const frameEl = document.getElementById('patient-game-frame');

    async function fetchAssignedGames(sessionId) {
      statusEl.textContent = 'Consultando juegos de la sesión...';
      listEl.innerHTML = '';
      frameEl.removeAttribute('src');
      try {
        const res = await fetch(`/api/sessions/${sessionId}/games`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error al consultar la sesión');

        if (!data.enabled) {
          statusEl.textContent = 'Aún no habilitados. Espera el horario de la sesión.';
        } else {
          statusEl.textContent = 'Juegos habilitados. Selecciona uno para abrir.';
        }

        const games = data.games || [];
        if (games.length === 0) {
          const li = document.createElement('li');
          li.className = 'text-sm text-gray-500';
          li.textContent = 'No hay juegos asignados.';
          listEl.appendChild(li);
          return;
        }

        games.forEach((g) => {
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between p-2 rounded-soft bg-gray-50';
          const name = document.createElement('span');
          name.className = 'text-sm text-textDark';
          name.textContent = g;
          const open = document.createElement('button');
          open.className = 'px-3 py-1 bg-primary text-white text-xs rounded-soft';
          open.textContent = 'Abrir';
          open.addEventListener('click', () => {
            frameEl.src = `/static/games/${g}`;
          });
          li.appendChild(name);
          li.appendChild(open);
          listEl.appendChild(li);
        });
      } catch (e) {
        statusEl.textContent = e.message;
      }
    }

    loadBtn.addEventListener('click', () => {
      const id = sessionInput.value.trim();
      if (!id) {
        statusEl.textContent = 'Ingresa un ID de sesión válido.';
        return;
      }
      fetchAssignedGames(id);
    });
  });
</script>
{% endblock %}
