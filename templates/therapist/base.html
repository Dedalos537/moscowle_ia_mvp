<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Centro de Terapias{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    window.FontAwesomeConfig = { autoReplaceSvg: "nest" };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#75a83a",
            olive: "#75a83a",
            background: "#f9fcf8",
            surface: "#ffffff",
            textDark: "#374151",
            charcoal: "#374151",
            lightGreen: "#ecfccb",
            accent: "#3b82f6",
            statusGreen: "#10b981",
            statusYellow: "#f59e0b",
            statusRed: "#ef4444",
          },
          fontFamily: {
            sans: ["Inter", "sans-serif"],
          },
          borderRadius: {
            soft: "1.5rem",
          },
          boxShadow: {
            soft: "0 10px 30px -5px rgba(117, 168, 58, 0.15)",
            "soft-lg": "0 20px 40px -10px rgba(117, 168, 58, 0.2)",
          },
        },
      },
    };
  </script>
  <style>
    ::-webkit-scrollbar {
      display: none;
    }

    /* Skeleton Loading Animation */
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }

    .skeleton-loader {
        animation: shimmer 2s infinite linear;
        background: linear-gradient(to right, #f6f7f8 4%, #edeef1 25%, #f6f7f8 36%);
        background-size: 1000px 100%;
    }

    .skeleton-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #f9fcf8;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.4s ease-in-out, visibility 0.4s;
    }

    .skeleton-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-content {
      animation: fadeIn 0.5s ease-in-out;
    }
  </style>
</head>

<body class="bg-background font-sans text-textDark">
    <!-- Skeleton Loader Overlay -->
    <div id="page-transition-skeleton" class="skeleton-overlay">
        <!-- Sidebar Skeleton -->
        <div class="fixed left-0 top-0 h-screen w-72 bg-white shadow-soft-lg flex flex-col z-50 hidden lg:flex p-6 space-y-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-soft skeleton-loader"></div>
                <div class="space-y-2">
                    <div class="h-4 w-32 skeleton-loader rounded"></div>
                    <div class="h-3 w-24 skeleton-loader rounded"></div>
                </div>
            </div>
            <div class="space-y-3">
                <div class="h-12 w-full skeleton-loader rounded-xl"></div>
                <div class="h-12 w-full skeleton-loader rounded-xl"></div>
                <div class="h-12 w-full skeleton-loader rounded-xl"></div>
                <div class="h-12 w-full skeleton-loader rounded-xl"></div>
                <div class="h-12 w-full skeleton-loader rounded-xl"></div>
            </div>
        </div>

        <!-- Main Content Skeleton -->
        <div class="lg:ml-72 min-h-screen flex flex-col">
            <!-- Header Skeleton -->
            <div class="h-20 bg-white border-b border-gray-100 flex items-center justify-between px-8">
                <div class="h-8 w-48 skeleton-loader rounded"></div>
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full skeleton-loader"></div>
                    <div class="w-10 h-10 rounded-full skeleton-loader"></div>
                </div>
            </div>
            
            <!-- Content Skeleton -->
            <div class="p-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="h-32 bg-white rounded-soft shadow-soft skeleton-loader"></div>
                    <div class="h-32 bg-white rounded-soft shadow-soft skeleton-loader"></div>
                    <div class="h-32 bg-white rounded-soft shadow-soft skeleton-loader"></div>
                </div>
                <div class="h-96 bg-white rounded-soft shadow-soft skeleton-loader"></div>
            </div>
        </div>
    </div>

  <!-- Toast Utility -->
  <div id="toast-container" class="fixed top-6 right-6 z-50 space-y-3"></div>
  <script>
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const el = document.createElement('div');
      el.className = `bg-white border-l-4 ${type === 'error' ? 'border-statusRed' : 'border-olive'} rounded-lg shadow-lg p-4 max-w-sm`;
      el.innerHTML = `
        <div class=\"flex items-center\">\n          <i class=\"fas ${type === 'error' ? 'fa-exclamation-circle text-statusRed' : 'fa-check-circle text-olive'} text-xl mr-3\"></i>\n          <p class=\"text-charcoal\">${message}</p>\n        </div>`;
      container.appendChild(el);
      setTimeout(() => {
        el.classList.add('opacity-0');
        el.style.transition = 'opacity 0.4s';
        setTimeout(() => el.remove(), 400);
      }, 2000);
    }
  </script>
  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-40 hidden lg:hidden transition-opacity duration-300 opacity-0"></div>
  <div id="sidebar" class="fixed left-0 top-0 h-screen w-72 bg-surface shadow-soft-lg flex flex-col overflow-y-auto transition-transform duration-300 z-50 -translate-x-full lg:translate-x-0">
    <div id="logo-section" class="px-8 py-8 border-b border-gray-100 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 bg-primary rounded-soft flex items-center justify-center">
          <i class="fa-solid fa-brain text-white text-xl"></i>
        </div>
        <div>
          <h1 class="text-lg font-bold text-textDark leading-tight">
            Centro de Terapias
          </h1>
          <p class="text-xs text-gray-500 font-medium">Juan Pablo II</p>
        </div>
      </div>
      <button id="close-sidebar-btn" class="lg:hidden text-gray-500 hover:text-primary">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    {% if current_user.role == 'terapista' %}
    <nav id="main-navigation" class="flex-1 px-4 py-6 space-y-2">
      <a href="{{ url_for('dashboard') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'dashboard' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all">
        <i class="fa-solid fa-chart-line text-lg"></i>
        <span class="font-semibold">Dashboard</span>
      </a>
      <a href="{{ url_for('manage_patients') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'patients' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all">
        <i class="fa-solid fa-users text-lg"></i>
        <span class="font-medium">Pacientes</span>
      </a>
      <a href="{{ url_for('games_list') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'games' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all">
        <i class="fa-solid fa-gamepad text-lg"></i>
        <span class="font-medium">Ejercicios</span>
      </a>
      <a href="{{ url_for('analytics') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'analytics' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all">
        <i class="fa-solid fa-chart-line text-lg"></i>
        <span class="font-medium">IA Analytics</span>
      </a>
      <a href="{{ url_for('sessions') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'sessions' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all">
        <i class="fa-solid fa-calendar-check text-lg"></i>
        <span class="font-medium">Sesiones</span>
      </a>
      <a href="{{ url_for('reports') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'reports' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all">
        <i class="fa-solid fa-file-alt text-lg"></i>
        <span class="font-medium">Reportes</span>
      </a>
      <a href="{{ url_for('messages_list') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'messages' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all relative">
        <i class="fa-solid fa-envelope text-lg"></i>
        <span class="font-medium">Mensajes</span>
        <span id="sidebar-unread-badge" class="hidden absolute top-4 right-4 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
      </a>
      
      {% endif %}
      {% if current_user.role == 'admin' %}
      <div class="pt-2 mt-2 border-t border-gray-100"></div>
      <a href="{{ url_for('admin_dashboard') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'admin_dashboard' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all">
        <i class="fa-solid fa-toolbox text-lg"></i>
        <span class="font-medium">Admin Panel</span>
      </a>
      <a href="{{ url_for('admin_users') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'admin_users' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all">
        <i class="fa-solid fa-user-gear text-lg"></i>
        <span class="font-medium">Admin Usuarios</span>
      </a>
      <a href="{{ url_for('admin_games') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'admin_games' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all">
        <i class="fa-solid fa-gamepad text-lg"></i>
        <span class="font-medium">Admin Juegos</span>
      </a>
      <a href="{{ url_for('admin_reports') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'admin_reports' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all">
        <i class="fa-solid fa-chart-pie text-lg"></i>
        <span class="font-medium">Admin Reportes</span>
      </a>
      <a href="{{ url_for('admin_messages') }}"
        class="flex items-center gap-4 px-6 py-4 rounded-soft {% if active_page == 'admin_messages' %}bg-primary text-white shadow-soft{% else %}text-gray-600 hover:bg-lightGreen hover:text-primary{% endif %} transition-all">
        <i class="fa-solid fa-envelope text-lg"></i>
        <span class="font-medium">Admin Mensajes</span>
      </a>
       {% endif %}
      
  
        </div>
      </div>
    </div>
  </div>

  <div id="main-content" class="lg:ml-72 min-h-screen fade-in-content transition-all duration-300">
    <header class="bg-surface border-b border-gray-100 px-4 md:px-8 py-5 sticky top-0 z-30">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button id="mobile-menu-btn" class="lg:hidden text-gray-600 hover:text-primary focus:outline-none">
            <i class="fas fa-bars text-2xl"></i>
          </button>
          {% block header_content %}
          <div>
            <h2 class="text-xl md:text-2xl font-bold text-textDark">Panel de Control</h2>
            <p class="text-xs md:text-sm text-gray-500 hidden md:block">
              Monitoreo y gestión de pacientes
            </p>
          </div>
          {% endblock %}
        </div>
        <div class="flex items-center gap-2 md:gap-4">
          <div class="relative">
            <button id="notification-bell"
              class="relative p-3 rounded-full bg-lightGreen text-primary hover:bg-primary hover:text-white transition-all">
              <i class="fa-solid fa-bell text-lg"></i>
              <span id="notification-count"
                class="absolute -top-1 -right-1 w-5 h-5 bg-statusRed rounded-full text-white text-xs flex items-center justify-center font-bold hidden"></span>
            </button>

            <div id="notification-popover"
              class="fixed left-4 right-4 top-20 w-auto md:absolute md:top-auto md:left-auto md:right-0 md:mt-3 md:w-80 bg-white rounded-soft shadow-soft-lg border border-gray-100 z-50 hidden">
              <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-md font-bold text-textDark">
                  Notificaciones
                </h3>
              </div>
              <div id="notification-list" class="p-2 max-h-96 overflow-y-auto"></div>
              <div class="p-2 bg-gray-50 text-center rounded-b-soft">
                <a href="#" id="mark-all-read" class="text-sm text-primary font-medium hover:underline">Marcar todas
                  como leídas</a>
              </div>
            </div>
          </div>

          {% block header_action %}
          <button
            class="px-3 py-2 md:px-5 md:py-2 bg-primary text-white rounded-soft hover:bg-opacity-90 transition-all shadow-soft font-medium text-sm md:text-base">
            <i class="fas fa-plus md:mr-2"></i>
            <span class="hidden md:inline">Nueva Sesión</span>
          </button>
          {% endblock %}

          <!-- User Profile Dropdown -->
          <div class="relative group">
              <button id="user-menu-btn" class="flex items-center space-x-3 focus:outline-none">
                  <div class="w-10 h-10 rounded-full bg-olive text-white flex items-center justify-center text-lg font-bold shadow-md border-2 border-white">
                      {{ current_user.username[0].upper() if current_user.username else 'U' }}
                  </div>
                  <div class="hidden md:block text-left">
                      <p class="text-sm font-bold text-charcoal leading-tight">{{ current_user.username or current_user.email }}</p>
                      <p class="text-xs text-gray-500">{{ current_user.role|capitalize }}</p>
                  </div>
                  <i class="fas fa-chevron-down text-gray-400 text-xs hidden md:block group-hover:text-olive transition-colors"></i>
              </button>
              
              <!-- Dropdown Menu -->
              <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-2 invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all duration-200 transform origin-top-right z-50 border border-gray-100">
                  <div class="px-4 py-2 border-b border-gray-50 md:hidden">
                      <p class="text-sm font-bold text-charcoal">{{ current_user.username or current_user.email }}</p>
                      <p class="text-xs text-gray-500">{{ current_user.role|capitalize }}</p>
                  </div>
                  <a href="{{ url_for('profile') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-olive transition-colors">
                      <i class="fas fa-user-circle w-5 text-center mr-2"></i> Mi Perfil
                  </a>
                  <button onclick="showLogoutModal()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                      <i class="fas fa-sign-out-alt w-5 text-center mr-2"></i> Cerrar Sesión
                  </button>
              </div>
          </div>
        </div>
      </div>
    </header>
    <main>{% block content %}{% endblock %}</main>
   


    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4 overflow-hidden">
        <div class="px-6 py-4 border-b flex items-center space-x-3 bg-red-50">
          <i class="fas fa-sign-out-alt text-red-500 text-2xl"></i>
          <h3 class="text-lg font-semibold text-charcoal">Cerrar Sesión</h3>
        </div>
        <div class="px-6 py-4">
          <p class="text-gray-700">¿Estás seguro de que deseas cerrar sesión?</p>
        </div>
        <div class="px-6 py-4 bg-gray-50 border-t flex justify-end space-x-3">
          <button id="logout-cancel-btn"
            class="px-6 py-2 bg-gray-300 text-charcoal rounded-lg font-medium hover:bg-gray-400 transition-colors">
            Cancelar
          </button>
          <button id="logout-confirm-btn"
            class="px-6 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors">
            Cerrar Sesión
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Sidebar Logic
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const closeSidebarBtn = document.getElementById('close-sidebar-btn');

      function openSidebar() {
        sidebar.classList.remove('-translate-x-full');
        sidebarOverlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Lock body scroll
        // small delay to allow display:block to apply before opacity transition
        setTimeout(() => {
            sidebarOverlay.classList.remove('opacity-0');
        }, 10);
      }

      function closeSidebar() {
        sidebar.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('opacity-0');
        document.body.style.overflow = ''; // Unlock body scroll
        setTimeout(() => {
            sidebarOverlay.classList.add('hidden');
        }, 300);
      }

      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', openSidebar);
      }

      if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener('click', closeSidebar);
      }

      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebar);
      }

      const notificationBell = document.getElementById("notification-bell");
      const notificationPopover = document.getElementById(
        "notification-popover"
      );
      const notificationList = document.getElementById("notification-list");
      const notificationCount = document.getElementById("notification-count");
      const markAllRead = document.getElementById("mark-all-read");

      function fetchNotifications() {
        fetch("/api/notifications")
          .then((response) => response.json())
          .then((data) => {
            notificationList.innerHTML = "";
            if (data.length > 0) {
              notificationCount.textContent = data.length;
              notificationCount.classList.remove("hidden");
              data.forEach((notif) => {
                const notifElement = `
                            <div class="p-3 hover:bg-lightGreen rounded-lg transition-colors">
                                <div class="flex items-start gap-3">
                                    <div class="w-8 h-8 bg-lightGreen rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                                        <i class="fas fa-info-circle text-primary"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-textDark">${notif.message
                  }</p>
                                        <p class="text-xs text-gray-400 mt-1">${notif.timestamp
                  }</p>
                                        ${notif.link
                    ? `<a href="${notif.link}" class="text-xs text-primary hover:underline">Ver detalles</a>`
                    : ""
                  }
                                    </div>
                                </div>
                            </div>
                        `;
                notificationList.insertAdjacentHTML(
                  "beforeend",
                  notifElement
                );
              });
            } else {
              notificationCount.classList.add("hidden");
              notificationList.innerHTML =
                '<p class="text-sm text-gray-500 text-center p-8">No tienes notificaciones nuevas.</p>';
            }
          });
      }

      notificationBell.addEventListener("click", (event) => {
        event.stopPropagation();
        const isHidden = notificationPopover.classList.toggle("hidden");
        if (!isHidden) {
          fetchNotifications();
          // Mark as read when opening
          fetch("/api/notifications/mark-read", { method: "POST" });
          
          // Smart Positioning Logic
          const rect = notificationPopover.getBoundingClientRect();
          const viewportWidth = window.innerWidth;
          
          // If right edge overflows, align to right
          if (rect.right > viewportWidth) {
              notificationPopover.style.right = '0';
              notificationPopover.style.left = 'auto';
          }
          
          // If left edge overflows (less likely with right-0 but possible on small screens if width is large)
          if (rect.left < 0) {
              notificationPopover.style.left = '0';
              notificationPopover.style.right = 'auto';
          }
          
          // Mobile override: ensure it stays within bounds
          if (viewportWidth < 768) {
              notificationPopover.style.left = '1rem';
              notificationPopover.style.right = '1rem';
              notificationPopover.style.width = 'auto';
          }
        }
      });

      markAllRead.addEventListener("click", (e) => {
        e.preventDefault();
        fetch("/api/notifications/mark-read", { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              fetchNotifications();
              showToast('Notificaciones marcadas como leídas');
            }
          });
      });

      // Close popover if clicking outside
      document.addEventListener("click", (event) => {
        if (
          !notificationPopover.contains(event.target) &&
          !notificationBell.contains(event.target)
        ) {
          notificationPopover.classList.add("hidden");
        }
      });

      // Initial fetch for the notification count
      fetchNotifications();

      // Poll for new notifications every 30 seconds
      setInterval(fetchNotifications, 30000);

      // Fetch unread message count
      function fetchUnreadMessages() {
        const badge = document.getElementById("sidebar-unread-badge");
        if (!badge) return; // Sidebar badge removed in some roles
        fetch("/api/messages/unread-count")
          .then((res) => res.json())
          .then((data) => {
            if (data.count > 0) {
              badge.textContent = data.count > 9 ? "9+" : data.count;
              badge.classList.remove("hidden");
            } else {
              badge.classList.add("hidden");
            }
          })
          .catch((err) =>
            console.error("Error fetching unread messages:", err)
          );
      }

      // Initial fetch and poll every 30 seconds
      fetchUnreadMessages();
      setInterval(fetchUnreadMessages, 30000);
    });

    // Logout confirmation modal
    const logoutModal = document.getElementById('logoutModal');
    const logoutBtnHeader = document.getElementById('logout-btn-header');
    const logoutBtnSidebar = document.getElementById('logout-btn-sidebar');
    const logoutCancelBtn = document.getElementById('logout-cancel-btn');
    const logoutConfirmBtn = document.getElementById('logout-confirm-btn');

    function showLogoutModal() {
      logoutModal.classList.remove('hidden');
      document.body.classList.add('modal-open');
    }

    function closeLogoutModal() {
      logoutModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
    }

    if (logoutBtnHeader) {
      logoutBtnHeader.addEventListener('click', showLogoutModal);
    }
    if (logoutBtnSidebar) {
      logoutBtnSidebar.addEventListener('click', showLogoutModal);
    }
    if (logoutCancelBtn) {
      logoutCancelBtn.addEventListener('click', closeLogoutModal);
    }
    if (logoutConfirmBtn) {
      logoutConfirmBtn.addEventListener('click', () => {
        window.location.href = '{{ url_for("logout") }}';
      });
    }

    // Mobile User Menu Toggle
    const userMenuBtn = document.getElementById('user-menu-btn');
    if (userMenuBtn) {
        userMenuBtn.addEventListener('click', function(e) {
            // On mobile, we might want to toggle visibility if hover doesn't work well
            // But since we use group-hover, let's just ensure it works.
            // Actually, for touch devices, clicking usually triggers hover state.
            // If we want explicit toggle, we'd need to toggle a class on the parent.
            const dropdown = this.nextElementSibling;
            if (window.innerWidth < 768) { // Mobile only check
                 // Simple toggle logic could go here if needed, but CSS hover often suffices.
                 // Let's leave it to CSS for now to avoid conflict.
            }
        });
    }

    // Close modal on backdrop click
    logoutModal.addEventListener('click', (e) => {
      if (e.target === logoutModal) {
        closeLogoutModal();
      }
    });
  </script>
  
  {% block extra_scripts %}{% endblock %}
  <script>
    // Skeleton Loader Logic
    document.addEventListener('DOMContentLoaded', () => {
        const skeleton = document.getElementById('page-transition-skeleton');
        
        // Show skeleton on link clicks (internal links only)
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            // Check if it's a valid link, not a hash link, not a download, and internal
            if (link && link.href && 
                link.href.startsWith(window.location.origin) && 
                !link.getAttribute('target') && 
                !link.getAttribute('download') &&
                !link.href.includes('#') &&
                !link.href.includes('javascript:void(0)')) {
                
                // Don't show if it's just a modifier key click (new tab)
                if (e.ctrlKey || e.metaKey || e.shiftKey || e.altKey) return;

                skeleton.classList.add('active');
            }
        });

        // Hide skeleton when page is fully loaded (pageshow event handles back/forward cache)
        window.addEventListener('pageshow', () => {
            skeleton.classList.remove('active');
        });
    });
  </script>
</body>

</html>