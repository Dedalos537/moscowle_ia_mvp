{% extends "patient/base.html" %}

{% block title %}Mi Calendario - Moscowle{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <h2 class="text-3xl font-bold text-charcoal mb-2">Mi Calendario</h2>
    <p class="text-gray-600">Gestiona tus citas y sesiones de terapia</p>
</div>

<!-- Upcoming Appointments -->
<div class="bg-white rounded-soft shadow-soft p-6 mb-6">
    <h3 class="text-xl font-semibold text-charcoal mb-6 flex items-center">
        <i class="fas fa-calendar-check text-olive mr-3"></i>
        Próximas Citas
    </h3>
    
    <div class="space-y-4" id="appointments-list">
        <div class="text-center py-12">
            <i class="fas fa-calendar-plus text-gray-300 text-5xl mb-4"></i>
            <p class="text-gray-500 mb-2">No tienes citas programadas</p>
            <p class="text-sm text-gray-400">Tu terapeuta programará las sesiones</p>
        </div>
    </div>
</div>

<!-- Calendar View -->
<div class="bg-white rounded-soft shadow-soft p-4 md:p-6">
    <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
        <h3 class="text-xl font-semibold text-charcoal flex items-center">
            <i class="fas fa-calendar text-olive mr-3"></i>
            Vista del Mes
        </h3>
        <div class="flex items-center space-x-4 w-full md:w-auto justify-center">
            <button id="prev-month" class="w-10 h-10 rounded-lg border border-gray-300 flex items-center justify-center hover:bg-gray-50 transition-colors">
                <i class="fas fa-chevron-left text-gray-600"></i>
            </button>
            <span id="current-month" class="text-lg font-semibold text-charcoal min-w-[150px] md:min-w-[200px] text-center">Diciembre 2025</span>
            <button id="next-month" class="w-10 h-10 rounded-lg border border-gray-300 flex items-center justify-center hover:bg-gray-50 transition-colors">
                <i class="fas fa-chevron-right text-gray-600"></i>
            </button>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="overflow-x-auto">
        <div class="min-w-[600px]">
            <div class="grid grid-cols-7 gap-2">
                <!-- Day Headers -->
                <div class="text-center py-2 text-sm font-semibold text-gray-600">Dom</div>
                <div class="text-center py-2 text-sm font-semibold text-gray-600">Lun</div>
                <div class="text-center py-2 text-sm font-semibold text-gray-600">Mar</div>
                <div class="text-center py-2 text-sm font-semibold text-gray-600">Mié</div>
                <div class="text-center py-2 text-sm font-semibold text-gray-600">Jue</div>
                <div class="text-center py-2 text-sm font-semibold text-gray-600">Vie</div>
                <div class="text-center py-2 text-sm font-semibold text-gray-600">Sáb</div>
                
                <!-- Calendar Days (will be generated by JS) -->
                <div id="calendar-days" class="col-span-7 grid grid-cols-7 gap-2"></div>
            </div>
        </div>
    </div>
</div>
<!-- Day details modal -->
<div id="dayModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-soft max-w-xl w-full mx-4 p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modal-date" class="text-lg font-semibold"></h3>
            <button id="modal-close" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times"></i></button>
        </div>
        <div id="modal-appointments" class="space-y-3">
            <p class="text-sm text-gray-500">Cargando citas...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentDate = new Date();
    let appointments = [];
    
    function loadAppointments() {
        // Load appointments for the currently displayed month range
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthStart = new Date(year, month, 1);
        const monthEnd = new Date(year, month + 1, 0);
        const qs = `?start=${monthStart.toISOString()}&end=${monthEnd.toISOString()}`;
        fetch('/api/appointments/patient' + qs)
            .then(res => res.json())
            .then(data => {
                appointments = Array.isArray(data) ? data : [];
                displayAppointmentsList();
                renderCalendar();
            })
            .catch(err => console.error('Error loading appointments:', err));
    }
    
    function displayAppointmentsList() {
        const listContainer = document.getElementById('appointments-list');
        
        if (appointments.length === 0) {
            listContainer.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-calendar-plus text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500 mb-2">No tienes citas programadas</p>
                    <p class="text-sm text-gray-400">Tu terapeuta programará las sesiones</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        // Sort upcoming appointments by date
        appointments.sort((a,b) => new Date(a.start) - new Date(b.start));
        appointments.forEach(appt => {
            const startDate = new Date(appt.start);
            const dateStr = startDate.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = startDate.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const statusColors = {
                'scheduled': 'bg-blue-100 text-blue-700',
                'completed': 'bg-green-100 text-green-700',
                'cancelled': 'bg-red-100 text-red-700'
            };
            const statusText = {
                'scheduled': 'Programada',
                'completed': 'Completada',
                'cancelled': 'Cancelada'
            };
            
            html += `
                <div class="border border-gray-200 rounded-xl p-4 hover:border-olive transition-colors bg-white">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-semibold text-charcoal mb-1">${appt.title || 'Sesión de Terapia'}</h4>
                            <div class="space-y-1 text-sm text-gray-600">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-calendar text-olive"></i>
                                    <span>${dateStr}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-clock text-olive"></i>
                                    <span>${timeStr}</span>
                                </div>
                                ${appt.location ? `
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-location-dot text-olive"></i>
                                    <span>${appt.location}</span>
                                </div>
                                ` : ''}
                                ${appt.therapist ? `
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-user-doctor text-olive"></i>
                                    <span>${appt.therapist.name}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColors[appt.status] || 'bg-gray-100 text-gray-700'}">
                            ${statusText[appt.status] || appt.status}
                        </span>
                    </div>
                    ${appt.notes ? `
                    <div class="mt-3 pt-3 border-t border-gray-100 text-sm text-gray-600">
                        <i class="fas fa-note-sticky text-olive mr-2"></i>${appt.notes}
                    </div>
                    ` : ''}
                        ${appt.games && appt.games.length ? `
                        <div class="mt-3 pt-3 border-t border-gray-100 text-sm text-gray-600 flex items-center justify-between">
                            <div><i class="fas fa-gamepad text-olive mr-2"></i>Juego asignado: <strong>${appt.games[0].replace(/\.html$/i,'')}</strong></div>
                            <div><button class="px-3 py-1 bg-primary text-white text-xs rounded-soft open-game-btn" data-game="${appt.games[0]}">Abrir Juego</button></div>
                        </div>
                        ` : ''}
                </div>
            `;
        });
        
        listContainer.innerHTML = html;
    }
    
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Build a map day -> appointments for the month
        const monthStart = new Date(year, month, 1);
        const monthEnd = new Date(year, month + 1, 0);
        const apptsByDay = {};
        appointments.forEach(appt => {
            const apptDate = new Date(appt.start);
            if (apptDate >= monthStart && apptDate <= monthEnd) {
                const d = apptDate.getDate();
                (apptsByDay[d] = apptsByDay[d] || []).push(appt);
            }
        });

        let html = '';
        const today = new Date();
        // Build a 6x7 grid (42 cells) for consistent layout
        let dayCounter = 1 - firstDay;
        for (let cell = 0; cell < 42; cell++, dayCounter++) {
            if (dayCounter < 1 || dayCounter > daysInMonth) {
                html += '<div class="aspect-square p-2 border border-transparent rounded-lg"></div>';
                continue;
            }
            const isToday = dayCounter === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            const dayAppts = apptsByDay[dayCounter] || [];
            html += `
                <div class="aspect-square p-2 border border-gray-200 rounded-lg hover:shadow-md transition-all relative bg-white ${isToday ? 'ring-2 ring-olive' : ''}" data-day="${dayCounter}">
                    <div class="flex justify-between items-start">
                        <div class="text-sm font-medium">${dayCounter}</div>
                        ${dayAppts.length ? `<span class="text-xs bg-blue-500 text-white px-2 py-0.5 rounded-full">${dayAppts.length}</span>` : ''}
                    </div>
                    ${dayAppts.length ? `<div class="mt-2 text-xs text-gray-600">${dayAppts.slice(0,2).map(a=> a.title || 'Sesión').join(' · ')}</div>` : ''}
                </div>`;
        }

        document.getElementById('calendar-days').innerHTML = html;

        // Attach click handlers for day cells that have data-day
        document.querySelectorAll('#calendar-days > div[data-day]').forEach(cell => {
            cell.addEventListener('click', () => {
                const day = parseInt(cell.getAttribute('data-day'));
                openDayModal(year, month, day, apptsByDay[day] || []);
            });
        });
    }
    
    document.getElementById('prev-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        loadAppointments();
    });
    
    document.getElementById('next-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        loadAppointments();
    });

    function openDayModal(year, month, day, dayAppts) {
        const modal = document.getElementById('dayModal');
        const date = new Date(year, month, day);
        document.getElementById('modal-date').textContent = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const container = document.getElementById('modal-appointments');
        if (!dayAppts.length) {
            container.innerHTML = '<p class="text-sm text-gray-600">No hay citas para este día.</p>';
        } else {
            container.innerHTML = dayAppts.map(appt => `
                <div class="border border-gray-100 rounded-lg p-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold">${appt.title || 'Sesión'}</h4>
                            <p class="text-xs text-gray-500">${new Date(appt.start).toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'})} - ${appt.location || ''}</p>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full ${appt.status === 'scheduled' ? 'bg-blue-100 text-blue-700' : appt.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${appt.status}</span>
                    </div>
                    ${appt.notes ? `<div class="mt-2 text-sm text-gray-700">${appt.notes}</div>` : ''}
                </div>
            `).join('');
        }
            // attach open-game handlers
            document.querySelectorAll('.open-game-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const g = btn.getAttribute('data-game');
                    if (g) window.open(`/static/games/${g}`, '_blank');
                });
            });
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    document.getElementById('modal-close').addEventListener('click', () => {
        const modal = document.getElementById('dayModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // Initial load
    loadAppointments();
</script>
{% endblock %}
